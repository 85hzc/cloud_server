var socket_arr = require('../../socket_arr');
var gateway_priv = require('../../gateway_priv');

var pg = require('pg');
var db = require('db');
var pgString = db.consqlString;

var client = new pg.Client(pgString);
client.connect();

function db_user_set_select_row_device_table(result)
{
    console.log("Enter db_user_set_select_row_device_table");

    if ( true != result.online)
    {
        this.setObj.error_code = 3;
    }

    //send command to gateway
    else
    {
        console.log(result);

        var socket = socket_arr.socket_arr_get(gateway_priv.gateway_socket_arr, result.gateway_id);
        
        if ( -1 == socket)
        {
            this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});

	    var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":" + this.setObj.error_code +"}";

            console.log(end_str);

	    this.setObj.res.end(end_str);
        }
        else
        {
            console.log(this.setObj.config);

            this.setObj.config = this.setObj.config.replace("[","");
            this.setObj.config = this.setObj.config.replace("]","");
            console.log(this.setObj.config)
            var cmd_str =  "{\"type\":\"set\", \"serial\":100, \"user_id\":\"" 
                           + this.setObj.userID 
                           + "\",\"device_id\":\"" 
                           + this.setObj.deviceID
                           + "\",\"device_type\":\""
                           + this.setObj.deviceType 
                           + "\",\"config\":"
                           + this.setObj.config
                           + "}";

            console.log(cmd_str);
         
            socket.write(cmd_str);
        }
    }
}

function db_user_set_select_user_table_end(result)
{
    if ( 0 == result.rowCount)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 2;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":" + this.setObj.error_code + "}";

	console.log(end_str);

        this.setObj.res.end(end_str);
    }

    else if ( 3 == this.setObj.error_code)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code +"}";

        console.log(end_str);

        this.setObj.res.end(end_str);
    }
}

function db_user_set_select_end_device_table(result)
{
    console.log("Enter db_user_set_select_device_table");

    if ( 0 == result.rowCount)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 1;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code +"}";

        console.log(end_str);
        this.setObj.res.end(end_str);
    }
    else
    {
        var select_str =  "SELECT * FROM user_table WHERE user_id = '"                                                                               
                           + this.setObj.userID
                           + "' AND device_type = '"                                                                                                 
                           + this.setObj.deviceType                                                                                                  
                           + "' AND device_id = '"                                                               
                           + this.setObj.deviceID                                                    
                           + "';"

        console.log(select_str);

        var select_query = client.query(select_str);
        select_query.setObj = this.setObj;
        select_query.on('end', db_user_set_select_user_table_end);
    }    
}

function db_user_query_select_device_table_row(result)
{
    console.log("Enter db_user_query_select_device_table_row");
    this.setObj.device_rows.push(result);
    console.log("Exit db_user_query_select_device_table_row");
}

function db_user_query_select_user_table_end(result)
{
    console.log("Enter db_user_query_select_user_table_end");

    if ( 0 == result.rowCount)
    {

        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 2;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":" + this.setObj.error_code + "}";

	console.log(end_str);

        this.setObj.res.end(end_str);
    }

    else
    {
       this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});

       if (true != this.setObj.device_rows[0].online)
	{
            this.setObj.error_code = 3;

            var end_str =  "{\"msg_type\":\"resp_user_query\","
                + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                + "\"error_code\":"  + this.setObj.error_code +"}";

	}
       
       else
       {
             var end_str =  "{\"msg_type\":\"resp_user_query\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code + ","
                     + "\"config\":[{\"power_switch\":\"" +this.setObj.device_rows[0].switch +"\"}]"
                     + "}";

       }

        console.log(end_str);

        this.setObj.res.end(end_str);
    }

    console.log("Enter db_user_query_select_user_table_end");
}

function db_user_query_select_device_table_end(result)
{
    console.log("Enter db_user_set_select_device_table");

    if ( 0 == result.rowCount)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 1;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code +"}";

        console.log(end_str);
        this.setObj.res.end(end_str);
    }
    else
    {
        var select_str =  "SELECT * FROM user_table WHERE user_id = '"                                                                               
                           + this.setObj.userID
                           + "' AND device_type = '"                                                                                                 
                           + this.setObj.deviceType                                                                                                  
                           + "' AND device_id = '"                                                               
                           + this.setObj.deviceID                                                    
                           + "';"

        console.log(select_str);

        var select_query = client.query(select_str);
        select_query.setObj = this.setObj;
        select_query.on('end', db_user_query_select_user_table_end);
    }    
}

function message_handle(req, res)
{      
    var message = req.body;
    console.log("Enter app config");
    console.log(message);  
    var msgType = message.msgType;
    console.log(msgType);
 //   console.log("1111");
//    console.log(req.headers);

    if ( "user_set" == msgType)
    {
        res.writeHead(200, {'Content-Type': 'application/json'});
        
        var end_str =  "{\"error_code\": \"1\"}";

        res.end(end_str);
    }

    else if ("user_query" == msgType)
    {
        var userID = message.userId;
        var devType = message.devType;
        res.writeHead(200, {'Content-Type': 'application/json'});        

        var deviceData = {
	    "deviceType" : "led",
	    "deviceDataModel" : [
		{
		    "deviceDataModelId" : "00000000001",
		    "controls": [
			{
			    "param": "power",
			    "type": "switch",
			    "displayType": "static",
			    "display":"电源",
			    "default": "1"
			},
			{
			    "param": "line1",
			    "type": "switch",
			    "displayType": "customer",
			    "display":"线路1",
			    "cDisplay":"line1Display",
			    "default": "1"
			},
			{
			    "param": "line2",
			    "type": "switch",
			    "displayType": "customer",
			    "display":"线路2",
			    "cDisplay":"line2Display",
			    "default": "1"
			}
		    ], 
		    "settings": [
			{
			    "param": "name",
			    "type": "text",
			    "display":"设备名称",
			    "default": "请输入设备别名"
			},
			{
			    "param": "line1Display",
			    "type": "text",
			    "display":"线路1设备名",
			    "default": "请输入被控制设备别名"
			},
			{
			    "param": "line2Display",
			    "type": "text",
			    "display":"线路2设备名",
			    "default": "请输入被控制设备别名"
			},
		    ],
		    "info": [
			{
			    "param": "manufacture",
			    "type": "text",
			    "display" : "生产厂商"
			},
			{
			    "param": "serialNumber",
			    "type": "text",
			    "display" : "序列号"
			},
			{
			    "param": "softwareVersion",
			    "type": "text",
			    "display" : "软件版本"
			},
		    ],
		},
	    ],
	    "deviceList" : [
		{
		    "deviceId" : "231384909801123",
		    "deviceDataModelId" : "00000000001",
		    "online": "1",
		    "devData": {
			"name" : "卧室",
			"power" : "1",
			"manufacture" : "feixun",
			"softwareVersion": "V1.0.0",
		    },
		    "userDevData" : {
			"nickname" : "led1",
			"group" : "地点",
		    }
		},
		{
		    "deviceId":"231384909801124", 
		    "deviceDataModelId" : "00000000001",
		    "online": "1",
		    "power": "1",
		    "devData": {
			"name" : "客厅",
			"power" : "1",
			"line1": "1",
			"line2": "0",
			"line1Display": "灯",
			"line2Display": "插座",
			"manufacture" : "feixun",
			"softwareVersion": "V1.0.0",
			"oui" : "001122",
			"serialNumber" : "1314151456",
		    },
		    "userDevData" : {
			"nickname" : "led2",
			"group" : "地点",
		    }
		}
	    ]
	};

        var end_str = JSON.stringify(deviceData);

        res.end(end_str);

    }
}

module.exports.message_handle = message_handle;

