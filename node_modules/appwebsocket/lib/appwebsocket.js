// var io = require('socket.io');

// var app = require('http').createServer(),
//   io = require('socket.io').listen(app);




//var http= require('http'); 
var io= require('socket.io'); 

/*var app = http.createServer();

var io = require('socket.io').listen(app);

app.listen(3000); 
*/


//var io= require('socket.io'); 


var mysql = require('mysql');
var db = require('db');
var client = mysql.createConnection(db.mysql);
client.connect();


var POLLING_INTERVAL = 500;


function message_handle(req, res){      
    var message = req.body;
    var msgType = message.msgType;
    
  
    if ( "dev_ctl" == msgType) {
        var userId = message.userId;
        var devId = message.devId;

        function pollingLoop() {

        var selectStr =  "SELECT  "
            + "iot_dev_datamodel.devDataModel,dev_user_mapping.deviceId,iot_device.online,iot_device.devData,iot_device.gatewayId "
            + "FROM (dev_user_mapping JOIN iot_device ON "
            + "dev_user_mapping.deviceId=iot_device.deviceId) "
            + "LEFT JOIN iot_dev_datamodel ON "
            + "iot_device.deviceDataModelId=iot_dev_datamodel.dataModelId "
            + "WHERE "
            + "dev_user_mapping.deviceId='" + devId + "' AND "
            + "dev_user_mapping.userId='" + userId + "';";

        console.log(selectStr);

          // 查询数据库
          var query = client.query(selectStr);
          // 加入查询到的结果到articles数组
          var selectData = [];
          // 查询结果监听
          query.on('result', function(row) {
              var Data={
                devId:row.deviceId,
                devData:{},
                devDataModel:{}

              };
              Data.devData=JSON.parse(row.devData);
              Data.devDataModel=JSON.parse(row.devDataModel);

              selectData.push(Data);
              console.log(selectData);

            })
              .on('end', function() {
              
            setTimeout('pollingLoop()', POLLING_INTERVAL);

            });
          }
        // 创建一个websocket连接，实时更新数据
        io.sockets.on('connection', function(socket) {

            //发送数据到客户端
            socket.emit('news',selectData );
            
        });
      }  
  }
module.exports.message_handle = message_handle;
