
var pg = require('pg');
var db = require('db');
var pgString = db.consqlString;

var client = new pg.Client(pgString);
client.connect();

function message_handle(req, res)
{
    var message = req.body;
    var msgType = message.msgType;
    
    console.log(req.body);
    if ("flow_inform" == msgType) {

		//JSON.stringify(this.setObj.devData) json转string
        var userId = message.userId;
		var SIP = message.SIP;
		var flow = message.flow;
        var manufacture = message.manufacture;
        var manufactureSN = message.serialNumber;
		
        var selectStr =  "SELECT monitor_device.\"deviceId\" FROM monitor_device "
            + "WHERE manufacture='" + manufacture + "' AND \"manufactureSN\"='" + manufactureSN + "';";

        client.query(selectStr, function(err, result) {
            if (err) {
                console.error(err.stack);
                send_result(res, 90001, "监控设备数据库查询错误！");
                return;
            }

            if(result.rowCount < 1) {
                /* Device has not connect to server */
                var insertStr = "INSERT INTO monitor_device(manufacture,\"manufactureSN\") VALUES('"
                                + manufacture + "','" + manufactureSN + "') RETURNING \"deviceId\";";
                client.query(insertStr, function(err, result) {
                    if (err) {
                        console.error(err.stack);
                        send_result(res, 90006, "监控设备表插入错误！");
                        return;
                    }
                    /*
                    var insertStr = "INSERT INTO monitor_date_list(\"deviceId\",\"userId\") VALUES('"
                                     + result.rows[0].deviceId + "','" + userId + "');";
					*/
					var insertStr = "INSERT INTO monitor_date_list (\"deviceId\", \"SIP\", \"DIP\", \"flow\") VALUES('"
									+ result.rows[0].deviceId + "','"
									+ SIP + "','"
									+ DIP + "','"
									+ flow + "');";
									 
                    client.query(insertStr, function(err, result) {
                        if (err) {
                            console.error(err.stack);
                            send_result(res, 90007, "新增监控设备监控规则表插入错误！");
                            return;
                        }

                        if(result.rowCount == 1) {
                            send_result(res, 0, "Success!");
                        } else {
                            send_result(res, 90007, "新增监控设备监控规则表插入错误！");
                        }
                    });
                });
            } else {

				var selectStr =  "SELECT monitor_date_list.\"flow\" FROM monitor_date_list "
					+ "WHERE deviceId='" + result.rows[0].deviceId 
					+ "' AND \"SIP\"='" + SIP + "';";

				client.query(selectStr, function(err, result) {
					if (err) {
						console.error(err.stack);
						send_result(res, 90001, "监控设备数据库查询错误！");
						return;
					}
					
					
					if(result.rowCount < 1) {
					
						var insertStr = "INSERT INTO monitor_date_list (\"deviceId\", \"SIP\", \"DIP\", \"flow\") VALUES('"
										+ result.rows[0].deviceId + "','"
										+ SIP + "','"
										+ DIP + "','"
										+ flow + "');";

						client.query(insertStr, function(err, result) {
							if (err) {
								console.error(err.stack);
								send_result(res, 90007, "监控设备规则表插入错误！");
								return;
							}

							send_result(res, 0, "Success!");
						});
						
					} else {
						
						var update_string = "UPDATE monitor_date_list"
								+ " SET \"flow\" = '"    + flow
								+ "' WHERE deviceId ='" + result.rows[0].deviceId
								+ "' AND \"SIP\" = '" + SIP + "';";

						client.query(update_string, function(err, result) {
							if (err) {
								console.error(err.stack);
								send_result(res, 90007, "监控设备规则表更新错误！");
								return;
							}

							send_result(res, 0, "Success!");
						});
					}
				}
            }
        });
    }
}

module.exports.message_handle = message_handle;
