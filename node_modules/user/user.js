var pg = require('pg');
var db = require('db');
var pgString = db.consqlString;
var crypto = require('crypto');

var client = new pg.Client(pgString);
client.connect();

function send_result(res, retCode, errStr, id) {
    var ret = {
        ret: retCode,
        errStr: errStr,
        userId: id
    };
    console.log(JSON.stringify(ret));
    res.send(JSON.stringify(ret));
}

function register(req, res)
{
    var message = req.body;
    var username = message.username;
    
    var md5 = crypto.createHash('md5');
    var password = md5.update(message.password).digest('base64');

    console.log("register username: " + username + ", password: " + message.password);

    var selectStr = "SELECT * "
        + "FROM user_table "
        + "WHERE "
        + "\"username\"='" + username + "';";

    client.query(selectStr, function(err, result) {
        if (err) throw err;

        if (result.rowCount > 0) {
            send_result(res, 91001, "用户已存在!");
            return;
        }
        else {
            var insertStr = "INSERT INTO user_table(username,password) "
                   + "VALUES('" + username + "','" + password +"');";
            console.log(insertStr);
            client.query(insertStr, function(err, result) {
                if (err) {
                    throw err;
                    send_result(res, 91002, "用户表插入错误!");
                }
                else {
                    if (result.rowCount == 1) {
                        send_result(res, 0, "Success!");
                    }
                    else {
                        send_result(res, 91002, "用户表插入错误!");
                    }
                }
            });
        }
    });
}

function login(req, res)
{
    var message = req.body;
    var username = message.username;

    var md5 = crypto.createHash('md5');
    var password = md5.update(message.password).digest('base64');

    console.log("login username: " + username + ", password: " + message.password);
    
    var selectStr = "SELECT * "
        + "FROM user_table "
        + "WHERE "
        + "\"username\"='" + username + "' AND \"password\"='" + password + "';";

    client.query(selectStr, function(err, result) {
        if (err) throw err;

        if (result.rowCount < 1) {
            send_result(res, 91003, "用户不存在!");
        }
        else if (result.rowCount == 1) {
            send_result(res, 0, "Success!", result.rows[0].userId);
        }
        else {
            send_result(res, 91004, "用户表查询错误!");
        }
    });
}


module.exports.register = register;
module.exports.login = login;
