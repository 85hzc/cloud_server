var socket_arr = require('../../socket_arr');
var gateway_priv = require('../../gateway_priv');

var pg = require('pg');
var db = require('db');
var pgString = db.consqlString;

var client = new pg.Client(pgString);
client.connect();

function db_user_set_select_row_device_table(result)
{
    console.log("Enter db_user_set_select_row_device_table");

    if ( true != result.online)
    {
        this.setObj.error_code = 3;
    }

    //send command to gateway
    else
    {
        console.log(result);

        var socket = socket_arr.socket_arr_get(gateway_priv.gateway_socket_arr, result.gateway_id);
        
        if ( -1 == socket)
        {
            this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});

	    var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":" + this.setObj.error_code +"}";

            console.log(end_str);

	    this.setObj.res.end(end_str);
        }
        else
        {
            console.log(this.setObj.config);

            this.setObj.config = this.setObj.config.replace("[","");
            this.setObj.config = this.setObj.config.replace("]","");
            console.log(this.setObj.config)
            var cmd_str =  "{\"type\":\"set\", \"serial\":100, \"user_id\":\"" 
                           + this.setObj.userID 
                           + "\",\"device_id\":\"" 
                           + this.setObj.deviceID
                           + "\",\"device_type\":\""
                           + this.setObj.deviceType 
                           + "\",\"config\":"
                           + this.setObj.config
                           + "}";

            console.log(cmd_str);
         
            socket.write(cmd_str);
        }
    }
}

function db_user_set_select_user_table_end(result)
{
    if ( 0 == result.rowCount)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 2;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":" + this.setObj.error_code + "}";

	console.log(end_str);

        this.setObj.res.end(end_str);
    }

    else if ( 3 == this.setObj.error_code)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code +"}";

        console.log(end_str);

        this.setObj.res.end(end_str);
    }
}

function db_user_set_select_end_device_table(result)
{
    console.log("Enter db_user_set_select_device_table");

    if ( 0 == result.rowCount)
    {
        this.setObj.res.writeHead(200, {'Content-Type': 'application/json'});
        this.setObj.error_code = 1;

        var end_str =  "{\"msg_type\":\"resp_user_set\","
                     + "\"dev_type\":\"" + this.setObj.deviceType + "\","
                     + "\"dev_id\":\""   + this.setObj.deviceID + "\","
                     + "\"error_code\":"  + this.setObj.error_code +"}";

        console.log(end_str);
        this.setObj.res.end(end_str);
    }
    else
    {
        var select_str =  "SELECT * FROM user_table WHERE user_id = '"                                                                               
                           + this.setObj.userID
                           + "' AND device_type = '"                                                                                                 
                           + this.setObj.deviceType                                                                                                  
                           + "' AND device_id = '"                                                               
                           + this.setObj.deviceID                                                    
                           + "';"

        console.log(select_str);

        var select_query = client.query(select_str);
        select_query.setObj = this.setObj;
        select_query.on('end', db_user_set_select_user_table_end);
    }    
}

function message_handle(req, res)
{      
    var message = req.body
    console.log(message);  
    var msgType = message.msg_type;
    console.log(msgType);

    if ("user_set" == msgType)
    {
        var userID = message.user_id;
        var deviceType = message.dev_type;
        var deviceID = message.dev_id;
        var config     = message.config;

        var setObj          = new Object();
        setObj.userID       = userID;
        setObj.deviceType   = deviceType;
        setObj.deviceID     = deviceID;
        setObj.config       = config;
        setObj.res          = res;
        setObj.error_code   = 0;

        var deviceTable = "device_" + deviceType;
        console.log(deviceTable);

        var select_str =  "SELECT * FROM "
                        + deviceTable
                        + " WHERE device_id = '"
                        + deviceID
                        + "';"

        console.log(select_str);       

        var select_query = client.query(select_str);
        select_query.setObj = setObj;
        select_query.on('row', db_user_set_select_row_device_table);
        select_query.on('end', db_user_set_select_end_device_table);
    }

    else if ("user_query" == msgType)
    {
        var userID = message.user_id;
        var deviceType = message.dev_type;
        var deviceID = message.dev_id;
        var config     = message.config;

        var setObj          = new Object();
        setObj.userID       = userID;
        setObj.deviceType   = deviceType;
        setObj.deviceID     = deviceID;
        setObj.config       = config;
        setObj.res          = res;
        setObj.error_code   = 0;


        var deviceTable = "device_" + deviceType;
        console.log(deviceTable);

        var select_str =  "SELECT * FROM "
                        + deviceTable
                        + " WHERE device_id = '"
                        + deviceID
                        + "';"

        console.log(select_str);       

        var select_query = client.query(select_str);
        select_query.setObj = setObj;
        select_query.on('row', db_user_query_select_device_table_row);
        select_query.on('end', db_user_query_select_device_table_end);
    }

}

module.exports.message_handle = message_handle;

