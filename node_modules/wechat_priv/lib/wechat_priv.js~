var socket_arr = require('../../socket_arr');
var m_user_query = require('./user_query');
var m_user_set = require('./user_set');

var pg = require('pg');
var pgString = "postgres://wudi:123@localhost/cloud_server_db";
var client = new pg.Client(pgString);
client.connect();

var weixin_socket_arr    = new Array();

var user_row_string = "";

function db_res_bind_select_query(select_result)
{
    console.log("Enter db_res_bind_select_query");

    if ( 0 == select_result.rowCount)
    {
        var insert_string = "INSERT INTO user_table VALUES ('"
                    + this.userID + "','"
                    + this.deviceID + "','"
                    + 1 + "')";

        console.log(insert_string);

        var insert_query = client.query(insert_string);
    }
    else
    {
        console.log(" 0 != row");
    }
}

/*
function device_row_result(result)
{
    console.log(result.rowCount);
    this.device_rows.push(result);
}

function device_end_result(result)
{
    console.log(result.rowCount);
    console.log(this.device_rows);

    var content_str = "您绑定设备的设备个数为" + result.rowCount + "\n\n";
    var i = 0;

    for ( i = 0; i < result.rowCount; i++)
    {
        if ( true == this.device_rows[i].online)
        {
            content_str = content_str + "设备id为" + this.device_rows[i].device_id + "的运行状态为" + this.device_rows[i].run_status + "\n\n";
        }

        else
        {
            content_str = content_str + "设备id为" + this.device_rows[i].device_id + "的运行状态为不在线.\n\n";
        }
    }

    this.res.reply({
                  type: 'text',
	          content: content_str
    });
}

function user_row_result(result)
{
//    console.log(result);
    this.user_rows.push(result);
}

function user_end_result(result)
{
    console.log("user_end_result rowCount = " + result.rowCount);
    
    if ( 0 == result.rowCount)
    {

        this.res.reply({
                  type: 'text',
	          content: '您没有绑定设备。'
        });

    }    
    
    else
    {
        var content_str = "您绑定设备的设备个数为" + result.rowCount + "\n";
  
        var i = 0;

        var select_str = "SELECT * FROM device_table WHERE (device_id = '" + this.user_rows[0].device_id + "'";

        for ( i = 1; i < this.user_rows.length; i++)
        {
            select_str = select_str + " OR device_id = '" + this.user_rows[i].device_id + "'";
        }

        select_str = select_str + ");";

        var select_device_query = client.query(select_str);
        select_device_query.res = this.res;
        select_device_query.device_rows = new Array();
        select_device_query.on('row', device_row_result);
        select_device_query.on('end', device_end_result);

        console.log(select_str);

        console.log(content_str);
//        console.log(result);

    }
}
*/
function message_handle(req, res)
{      
    
    var message = req.weixin;

    console.log(message);  

    var msgType = message.MsgType;

    var eventKey = message.EventKey;

    var weixin_user = message.FromUserName;

    console.log(msgType);

    if ( "device_event" == msgType)
    {       
        console.log("Enter device_event");
     
        console.log("event = " + message.Event);

        var userID = message.OpenID;

	var deviceID = message.DeviceID;

        if ( "bind" == message.Event)
        {
            console.log("Enter Event bind");
            var select_string = "SELECT * FROM user_table WHERE user_id = '" 
                                + userID + "' and device_id = '" + deviceID + "'";

            console.log(select_string);

            var select_query = client.query( select_string);
            select_query.userID   = userID;
            select_query.deviceID = deviceID;
            select_query.on('end', db_res_bind_select_query);
        }

        else if ( "unbind" == message.Event)
        {
            console.log("Enter Event unbind");
 
            var delete_string = "DELETE FROM user_table WHERE user_id = '"
                              + userID + "' and device_id = '" + deviceID + "'";
            var delete_query  = client.query(delete_string);
        }
    }

    else if ( "event" == msgType)
    {
	if (("query" == eventKey)
	    || ("turn_on" == eventKey)
	    || ("turn_off" == eventKey)
	   )
	{

            console.log("Enter weixin");
            req.socket.id = weixin_user;
            req.socket.res = res;
            socket_arr.socket_arr_add(weixin_socket_arr, req.socket, weixin_user);

            if ("query" == eventKey)
            {

                var query_string = "SELECT * FROM user_table WHERE user_id = '" + weixin_user + "';" ;
                var user_query = client.query(query_string);
                user_query.user_id = weixin_user;
                user_query.res = res;

                user_query.user_rows = new Array();
                user_query.on('row', m_user_query.user_row_result);
                user_query.on('end', m_user_query.user_end_result);
                   
              /*
                res.reply({
                  type: 'text',
                  content: 'query'
                }); */

            }

            else if ( "turn_on" == eventKey)
            {

                var query_string = "SELECT * FROM user_table WHERE user_id = '" + weixin_user + "';" ;
                var user_query = client.query(query_string);
                user_query.user_id = weixin_user;
                user_query.res = res;
                user_query.cmd = "turn_on";

                user_query.user_rows = new Array();
                user_query.on('row', m_user_set.user_row_result);
                user_query.on('end', m_user_set.user_end_result);

/*
                res.reply({
                  type: 'text',
                  content: 'turn on successfully'
                });
*/
            }

            else 
            {

                var query_string = "SELECT * FROM user_table WHERE user_id = '" + weixin_user + "';" ;
                var user_query = client.query(query_string);
                user_query.user_id = weixin_user;
                user_query.res = res;
                user_query.cmd = "turn_off";

                user_query.user_rows = new Array();
                user_query.on('row', m_user_set.user_row_result);
                user_query.on('end', m_user_set.user_end_result);
            }

            req.socket.on('close', weixin_close_socket);
        }
    }

    else
    {
    }

}


function weixin_close_socket()
{
    socket_arr.socket_arr_del(weixin_socket_arr, this.id);
}

module.exports.message_handle = message_handle;
module.exports.weixin_socket_arr = weixin_socket_arr;
